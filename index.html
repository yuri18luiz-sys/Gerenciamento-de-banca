<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GERENCIADOR DE BANCA OB</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Variáveis de Cor */
        :root {
            --bg-principal: #121212; 
            --bg-container: #1e1e1e; 
            --bg-input: #2d2d2d; 
            --cor-texto: #e0e0e0; 
            --cor-verde: #28a745; /* WIN */
            --cor-vermelha: #dc3545; /* LOSS */
            --cor-destaque: #58a6ff; 
            --cor-destaque-soft: #4a90e2; 
            --cor-neutra: #444c56;
        }

        /* ESTILOS GERAIS E RESPONSIVIDADE */
        body { 
            font-family: 'Roboto', sans-serif; 
            padding: 20px; 
            background-color: var(--bg-principal);
            color: var(--cor-texto);
            line-height: 1.6;
            min-height: 100vh;
        }
        .container { 
            max-width: 500px; 
            margin: 0 auto; 
            background: var(--bg-container); 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); 
            border: 1px solid #333;
        }
        .header-area {
            text-align: center;
            margin-bottom: 20px;
        }
        
        /* NOVO: Container para alinhar Título e Ícone de Ajuda */
        .title-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }

        h1 { 
            color: #FFF; 
            margin: 0 5px 0 0; /* Espaçamento do ícone */
            font-size: 2em;
        }
        
        #personalizacao { 
            font-size: 1.3em; 
            font-weight: bold; 
            text-transform: uppercase; 
            margin-bottom: 25px; 
            color: var(--cor-texto); 
        } 
        
        .campo { margin-bottom: 20px; }
        .campo label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: bold; 
            color: #bbb; 
            font-size: 0.95em;
        }
        
        /* Inputs e Botões */
        .campo input[type="number"] { 
            width: 100%; 
            padding: 14px; 
            box-sizing: border-box; 
            border: 1px solid #333; 
            border-radius: 8px; /* Cantos Arredondados do Input */
            background-color: var(--bg-input); 
            color: var(--cor-texto); 
            font-size: 1.05em;
        }
        .campo input[type="number"]:focus {
            border-color: var(--cor-destaque);
            outline: none;
        }

        button { 
            width: 100%; 
            padding: 14px; 
            border: none; 
            border-radius: 8px; /* Cantos Arredondados do Botão */
            cursor: pointer; 
            font-weight: bold; 
            font-size: 1.1em;
            transition: all 0.2s ease-in-out; 
            margin-top: 10px; 
            display: flex; 
            justify-content: center;
            align-items: center;
        }
        button:hover:not(.disabled) {
            transform: translateY(-1px); /* Leve animação no hover */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            opacity: 0.95;
        }

        /* Cores dos botões */
        button { background-color: var(--cor-destaque-soft); color: white; } /* Azul suave */
        .win { background-color: var(--cor-verde); color: white; } 
        .loss { background-color: var(--cor-vermelha); color: white; } 
        .disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .config-botoes button { background-color: #444; color: var(--cor-texto); } 
        .config-botoes button:hover:not(.disabled) { background-color: #555; }
        
        /* Saída e Infos */
        #resultado-entrada { 
            font-size: 1.4em; 
            color: var(--cor-texto); 
            text-align: center; 
            padding: 20px; 
            border: 1px solid #444; 
            border-radius: 10px; 
            margin-top: 25px; 
            background-color: var(--bg-input);
        }
        #banca-info { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 30px; 
            padding: 20px; 
            background-color: #282828; 
            border-radius: 10px; 
            border: 1px solid #333;
        }
        .banca-valor { 
            font-size: 1.3em; 
            font-weight: bold; 
            color: var(--cor-verde); /* Verde normal */
        }
        .banca-campo label { color: #bbb; margin-bottom: 5px; }


        /* Estilo Histórico */
        #estatisticas-historico { 
            display: flex; 
            justify-content: space-around; 
            margin-top: 20px; 
            padding: 15px; 
            background-color: #282828; 
            border-radius: 10px; 
            border: 1px solid #333;
        }
        #historico h3 { 
            color: var(--cor-texto); 
            border-bottom: 2px solid #333; 
            padding-bottom: 8px; 
            font-size: 1.4em; 
            text-align: center;
            margin-top: 40px;
            margin-bottom: 20px;
        }
        #lista-historico { list-style: none; padding: 0; }
        #lista-historico li { 
            display: flex; 
            justify-content: space-between; 
            padding: 12px; 
            border-bottom: 1px dashed #333; 
            font-size: 0.95em;
        }
        #lista-historico li:last-child { border-bottom: none; } 

        .historico-win { color: var(--cor-verde); font-weight: bold; } 
        .historico-loss { color: var(--cor-vermelha); font-weight: bold; } 
        
        hr { border-top: 1px solid #333; }

        /* Estilos da nova seção BINGO */
        .secao-meta { border-top: 3px solid var(--cor-verde); margin-top: 40px; padding-top: 20px; }
        .secao-meta h2 { color: var(--cor-texto); text-align: center; margin-bottom: 25px; } 
        #resultado-bingo { 
            border: 1px dashed var(--cor-verde); 
            background-color: var(--bg-input); 
            color: var(--cor-texto); 
            padding: 18px; 
            border-radius: 10px; 
            font-size: 1.1em;
            line-height: 1.8;
        }
        #progresso-diario { margin-top: 25px; text-align: center; }
        #progresso-diario p { margin-bottom: 8px; font-size: 1.05em; }
        #bingo-lucro-dia { color: var(--cor-verde); } 
        #bingo-meta-diaria { color: #ffc107; } 

        /* Barra de progresso */
        #win-loss-bar-container {
            width: 100%;
            height: 15px;
            background-color: var(--cor-vermelha); 
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.4);
        }
        #win-bar {
            height: 100%;
            width: 0%;
            background-color: var(--cor-verde); 
            transition: width 0.5s ease-in-out;
        }

        /* Tooltip style */
        .tooltip-icon {
            cursor: help;
            color: var(--cor-destaque-soft);
            margin-left: 5px;
            font-weight: bold;
        }
        
        /* Campo de Entrada em Destaque no Bingo */
        #bingo-valor-entrada-display {
            font-size: 1.5em;
            color: var(--cor-destaque);
            font-weight: bold;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #444;
            display: block; 
        }
        
        /* Remoção de Imagens e Ícones Visuais */
        .img-icon-btn, .header-icons { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-area">
        <div class="title-container">
            <h1>GERENCIADOR DE BANCA</h1>
            <span class="manual-link" onclick="mostrarManual()" title="Manual de Utilização">
                <i class="fas fa-book-open"></i> 
            </span>
        </div>
        <div id="personalizacao"></div> 
    </div>

    <div id="banca-info">
        <div class="banca-campo">
            <label>Banca Inicial:</label>
            <span id="banca-inicial" class="banca-valor">R$ 0,00</span>
        </div>
        <div class="banca-campo">
            <label>Banca Atual:</label>
            <span id="banca-atual" class="banca-valor">R$ 0,00</span>
        </div>
    </div>

    <div id="configuracoes">
        <h3 style="text-align: center; color: var(--cor-texto); margin-bottom: 20px;">Configurações de Entrada</h3>
        
        <div class="campo">
            <label for="input-banca-inicial">
                Definir Saldo Inicial
                <span class="tooltip-icon" title="O valor inicial (principal) da sua banca. Este valor é fixado para o cálculo do Stop Loss.">?</span>
            </label>
            <input type="number" id="input-banca-inicial" value="" step="0.01" placeholder="">
        </div>

        <div class="campo">
            <label for="meta-lucro">
                Meta de Lucro (%)
                <span class="tooltip-icon" title="Porcentagem de lucro REAL que você deseja fazer em cima da Banca Atual.">?</span>
            </label>
            <input type="number" id="meta-lucro" value="" step="0.01" placeholder="">
        </div>

        <div class="campo">
            <label for="stop-loss-percent">
                Stop Loss (%)
                <span class="tooltip-icon" title="Limite MÁXIMO de perda sobre o Saldo Inicial. Se atingida, as operações são BLOQUEADAS.">?</span>
            </label>
            <input type="number" id="stop-loss-percent" value="" min="0.01" max="99" step="0.01" placeholder="">
        </div>
        
        <div class="campo">
            <label for="payout-percent">
                Payout da Plataforma (%)
                <span class="tooltip-icon" title="O retorno percentual oferecido pela corretora em caso de WIN (Ex: 85% = 85).">?</span>
            </label>
            <input type="number" id="payout-percent" value="" min="0.01" max="99" step="0.01" placeholder="">
        </div>

        <div class="campo">
            <label for="num-entradas">
                Número de Entradas
                <span class="tooltip-icon" title="Em quantas operações você deseja dividir o valor total de investimento.">?</span>
            </label>
            <input type="number" id="num-entradas" value="" min="1" step="1" placeholder="">
        </div>

        <button onclick="calcularEntrada()">CALCULAR ENTRADA</button>
        <div id="resultado-entrada">Preencha os campos e clique em CALCULAR ENTRADA</div>
    </div>

    <hr>

    <div id="operacao-botoes" style="text-align: center; margin-top: 20px;">
        <button id="btn-nova-operacao" onclick="toggleResultadoBotoes(true)" style="background-color: var(--cor-destaque-soft); color: white; margin-bottom: 15px;" class="disabled" disabled>NOVA OPERAÇÃO</button>
        <div id="botoes-resultado" style="display: none;">
            <button class="win" onclick="registrarResultado('win')">
                WIN (Ganho)
            </button>
            <button class="loss" onclick="registrarResultado('loss')">
                LOSS (Perda)
            </button>
        </div>
    </div>

    <div id="historico">
        <h3>Estatísticas de Desempenho</h3>
        <p style="color: #8b949e; text-align: center; margin-bottom: 5px;">Progresso de WINs vs LOSSes</p>
        <div id="win-loss-bar-container"><div id="win-bar"></div></div> <div id="estatisticas-historico">
            <span>N° de WIN: <span id="count-wins" class="historico-win">0</span></span>
            <span>N° de LOSS: <span id="count-losses" class="historico-loss">0</span></span>
            <span>Total: <span id="count-total">0</span></span>
        </div>

        <h3>Últimas Operações</h3>
        <ul id="lista-historico">
            </ul>
        
        <div class="config-botoes">
            <button onclick="perguntarPersonalizacao()" style="background-color: var(--cor-neutra);">EDITAR NOME</button>
            <button onclick="tentarLimparHistorico()" class="loss">Limpar Histórico e Resetar Banca</button>
        </div>
    </div>

    <div id="bingo-secao" class="secao-meta">
        <h2>BINGO DO MÊS 🚀</h2>
        
        <div class="campo">
            <label for="bingo-meta-total">Meta Total (R$):</label>
            <input type="number" id="bingo-meta-total" value="" step="0.01" placeholder="">
        </div>
        
        <div class="campo">
            <label for="bingo-saldo-inicial">Saldo Atual (R$):</label>
            <input type="number" id="bingo-saldo-inicial" value="" step="0.01" placeholder="">
        </div>

        <div class="campo">
            <label for="bingo-num-dias">Total de WINs Planejados:</label>
            <input type="number" id="bingo-num-dias" value="" min="1" step="1" placeholder="">
        </div>

        <button onclick="calcularBingo()">CALCULAR ENTRADA</button>
        
        <div id="resultado-bingo">
        </div>

        <hr style="margin-top: 20px; border-style: dotted;">

        <div id="progresso-diario" style="display: none;">
            <h3>Progresso Diário</h3>
            <p>Saldo Atual: <strong id="bingo-saldo-display" class="banca-valor">R$ 0,00</strong></p>
            
            <p>Valor da Entrada: <strong id="bingo-valor-entrada-display" class="entrada-destaque">R$ 0,00</strong></p>

            <p>Lucro do Dia: <strong id="bingo-lucro-dia">R$ 0,00</strong></p>
            <p>Meta de Lucro por WIN: <strong id="bingo-meta-diaria">R$ 0,00</strong></p>
            <p>WINs Restantes: <strong id="bingo-wins-restantes">0</strong></p>
            
            <div id="botoes-bingo" class="config-botoes">
                <button class="win" id="btn-bingo-win" onclick="registrarBingo('win')">WIN</button>
                <button class="loss" id="btn-bingo-loss" onclick="registrarBingo('loss')">LOSS</button>
                <button onclick="resetarMetaDiaria()" style="background-color: #ffc107; color: #333;">Reiniciar Meta</button>
            </div>
        </div>
    </div>
    </div>

<script>
    // VARIÁVEIS GLOBAIS
    let bancaInicial = 0;
    let bancaAtual = 0;
    let valorPorEntrada = 0;
    let bancaInicialFixada = false;
    let payoutDecimal = 0;
    let historicoOperacoes = []; 
    let nomeUsuario = "";
    let saldoMinimoStopLoss = 0; 

    // VARIÁVEIS DO BINGO
    let bingoMetaTotal = 0;
    let bingoSaldoAtual = 0;
    let bingoNumDias = 0; // Total de WINs Planejados
    let bingoFatorCrescimento = 0; // Fator de Crescimento por WIN
    let bingoLucroDoDia = 0;
    let bingoValorEntrada = 0; 
    let bingoMetaDiariaLucro = 0; 
    let bingoWinsRestantes = 0; // Contador de WINs restantes
    const BINGO_PAYOUT = 0.85; // FIXO EM 85% CONFORME SOLICITADO

    // --- MANUAL DE INSTRUÇÕES (NOVA FUNÇÃO) ---
    function mostrarManual() {
        const manualParte1 = `
INSTRUÇÕES DO GERENCIADOR DE BANCA

Esta ferramenta calcula o valor exato que você deve INVESTIR para atingir sua meta de lucro REAL (líquido).

======================================
1. CONFIGURAÇÃO DE ENTRADA
======================================
1.1 Definir Saldo Inicial:
    • Insira o valor do seu capital principal.
    • ESTE VALOR É FIXO após o primeiro cálculo e será a base para o cálculo do Stop Loss.

1.2 Meta de Lucro (%):
    • Porcentagem de lucro líquido que você deseja fazer em cima da Banca Atual.

1.3 Stop Loss (%):
    • Limite MÁXIMO de perda sobre o Saldo Inicial. Se atingido, as operações são BLOQUEADAS.

1.4 Payout da Plataforma (%):
    • O retorno percentual que a corretora oferece (ex: 85 para 85%).

1.5 Número de Entradas:
    • Em quantas operações você deseja dividir o valor total de investimento.
        `;

        const manualParte2 = `
INSTRUÇÕES DO GERENCIADOR DE BANCA (PARTE 2)

======================================
2. BINGO DO MÊS (JUROS COMPOSTOS)
======================================
Esta seção calcula o crescimento necessário para uma meta agressiva por WIN (vitória).

2.1 Saldo e Meta:
    • 'Meta Total' / 'Saldo Atual': Use para projetar o crescimento. O Saldo Mínimo para começar é R$ 2,00.
    • 'Total de WINs Planejados' é o número de vitórias que você PRECISA para atingir a Meta Total (assumindo 85% de Payout fixo).

2.2 Progresso Diário:
    • 'WIN' / 'LOSS': Registra o resultado na simulação.
    • O contador 'WINs Restantes' diminui a cada WIN e aumenta em caso de LOSS, ajustando o plano em tempo real.
    
2.3 Reiniciar Meta:
    • Zera o progresso do BINGO (incluindo saldo, lucro do dia e contadores) para permitir o início de um novo plano.
        `;

        // Mostra a primeira parte e, após clicar em OK, mostra a segunda
        alert(manualParte1);
        alert(manualParte2);
    }
    // --- FIM MANUAL DE INSTRUÇÕES ---


    function salvarDados() {
        localStorage.setItem('bancaInicial', bancaInicial);
        localStorage.setItem('bancaAtual', bancaAtual);
        localStorage.setItem('bancaInicialFixada', bancaInicialFixada);
        localStorage.setItem('historicoOperacoes', JSON.stringify(historicoOperacoes));
        localStorage.setItem('nomeUsuario', nomeUsuario);
        localStorage.setItem('saldoMinimoStopLoss', saldoMinimoStopLoss); 
        
        // Salvar dados do Bingo
        localStorage.setItem('bingoMetaTotal', bingoMetaTotal);
        localStorage.setItem('bingoSaldoAtual', bingoSaldoAtual);
        localStorage.setItem('bingoNumDias', bingoNumDias);
        localStorage.setItem('bingoLucroDoDia', bingoLucroDoDia);
        localStorage.setItem('bingoFatorCrescimento', bingoFatorCrescimento);
        localStorage.setItem('bingoWinsRestantes', bingoWinsRestantes); 
        
        // Salvar valores dos inputs de configuração para persistência da sessão
        localStorage.setItem('inputMetaLucro', document.getElementById('meta-lucro').value);
        localStorage.setItem('inputStopLoss', document.getElementById('stop-loss-percent').value);
        localStorage.setItem('inputPayout', document.getElementById('payout-percent').value);
        localStorage.setItem('inputNumEntradas', document.getElementById('num-entradas').value);
    }

    function carregarDados() {
        const savedBancaInicial = localStorage.getItem('bancaInicial');
        const savedBancaAtual = localStorage.getItem('bancaAtual');
        const savedFixada = localStorage.getItem('bancaInicialFixada');
        const savedHistorico = localStorage.getItem('historicoOperacoes');
        const savedNome = localStorage.getItem('nomeUsuario');
        const savedSaldoMinimo = localStorage.getItem('saldoMinimoStopLoss');
        
        // Carregar inputs de configuração
        const inputMetaLucro = localStorage.getItem('inputMetaLucro');
        const inputStopLoss = localStorage.getItem('inputStopLoss');
        const inputPayout = localStorage.getItem('inputPayout');
        const inputNumEntradas = localStorage.getItem('inputNumEntradas');
        const inputBingoMetaTotal = localStorage.getItem('bingoMetaTotal');
        const inputBingoSaldoAtual = localStorage.getItem('bingoSaldoAtual');
        const inputBingoNumDias = localStorage.getItem('bingoNumDias');

        // Aplicar valores salvos aos inputs (para persistência)
        if (inputMetaLucro) document.getElementById('meta-lucro').value = inputMetaLucro;
        if (inputStopLoss) document.getElementById('stop-loss-percent').value = inputStopLoss;
        if (inputPayout) document.getElementById('payout-percent').value = inputPayout;
        if (inputNumEntradas) document.getElementById('num-entradas').value = inputNumEntradas;
        if (inputBingoMetaTotal) document.getElementById('bingo-meta-total').value = inputBingoMetaTotal;
        if (inputBingoSaldoAtual) document.getElementById('bingo-saldo-inicial').value = inputBingoSaldoAtual;
        if (inputBingoNumDias) document.getElementById('bingo-num-dias').value = inputBingoNumDias;
        
        // Carregar dados do Bingo
        const savedBingoMetaTotal = localStorage.getItem('bingoMetaTotal');
        const savedBingoSaldoAtual = localStorage.getItem('bingoSaldoAtual');
        const savedBingoNumDias = localStorage.getItem('bingoNumDias');
        const savedBingoLucroDoDia = localStorage.getItem('bingoLucroDoDia');
        const savedBingoFatorCrescimento = localStorage.getItem('bingoFatorCrescimento');
        const savedBingoWinsRestantes = localStorage.getItem('bingoWinsRestantes'); 

        // Lógica de personalização
        if (savedNome) {
            nomeUsuario = savedNome;
        } else {
            perguntarPersonalizacao();
            return; 
        }

        // Lógica da Banca Principal
        if (savedBancaInicial !== null) {
            bancaInicial = parseFloat(savedBancaInicial);
            bancaAtual = parseFloat(savedBancaAtual);
            bancaInicialFixada = (savedFixada === 'true');
        } else {
             bancaAtual = 0;
             bancaInicial = 0;
        }

        if (savedSaldoMinimo !== null) {
            saldoMinimoStopLoss = parseFloat(savedSaldoMinimo);
        }

        if (savedHistorico) {
            historicoOperacoes = JSON.parse(savedHistorico);
        }
        
        // Lógica de desabilitar o input se a banca já estiver fixada (e não for zero)
        const inputField = document.getElementById('input-banca-inicial');
        
        if (bancaInicialFixada && bancaAtual > 0) {
            inputField.value = bancaAtual.toFixed(2);
            inputField.disabled = true; 
            inputField.style.backgroundColor = '#21262d'; 
            inputField.style.color = '#8b949e'; 
        } else {
            inputField.disabled = false;
            inputField.style.backgroundColor = '#21262d'; 
            inputField.style.color = '#FFF'; 
            inputField.value = ""; 
        }
        
        // Carregar dados do Bingo
        if (savedBingoMetaTotal) {
            bingoMetaTotal = parseFloat(savedBingoMetaTotal);
            bingoSaldoAtual = parseFloat(savedBingoSaldoAtual);
            bingoNumDias = parseInt(savedBingoNumDias);
            bingoLucroDoDia = parseFloat(savedBingoLucroDoDia);
            bingoFatorCrescimento = parseFloat(savedBingoFatorCrescimento);
            bingoWinsRestantes = parseInt(savedBingoWinsRestantes); 

            if (bingoMetaTotal > 0 && bingoNumDias > 0 && bingoSaldoAtual > 0) {
                calcularBingo(true); 
            }
        }

        // Verifica o Stop Loss ao carregar para desabilitar o botão se necessário
        if (saldoMinimoStopLoss > 0 && bancaAtual <= saldoMinimoStopLoss) {
             document.getElementById('resultado-entrada').innerHTML = `
                <strong style="color: var(--cor-vermelha); font-size: 1.5em;">⛔ STOP LOSS ATINGIDO! ⛔</strong>
                <br>
                Prejuízo de R$ ${(bancaInicial - saldoMinimoStopLoss).toFixed(2).replace('.', ',')} atingido.
            `;
            document.getElementById('btn-nova-operacao').disabled = true;
            document.getElementById('btn-nova-operacao').classList.add('disabled');
        }
    }
    
    // --- FUNÇÃO DE PERSONALIZAÇÃO ---
    function perguntarPersonalizacao() {
        const nome = prompt("Digite seu Nome e Sobrenome:");
        if (nome && nome.trim() !== "") {
            nomeUsuario = nome.trim();
        } else {
            if (!nomeUsuario) nomeUsuario = "USUÁRIO"; 
        }
        salvarDados(); 
        atualizarDisplay(); 
    }

    // --- FUNÇÕES DE DISPLAY E INICIALIZAÇÃO ---
    function atualizarDisplay() {
        document.getElementById('banca-inicial').innerText = `R$ ${(bancaInicial || 0).toFixed(2).replace('.', ',')}`;
        document.getElementById('banca-atual').innerText = `R$ ${(bancaAtual || 0).toFixed(2).replace('.', ',')}`;
        
        const elementoPersonalizacao = document.getElementById('personalizacao');
        elementoPersonalizacao.innerText = nomeUsuario; 

        renderizarHistorico();
        atualizarDisplayBingo();
    }

    function lerBancaInicialInput() {
        const inputField = document.getElementById('input-banca-inicial');
        const inputBanca = parseFloat(inputField.value.replace(',', '.')); // CORREÇÃO: Lendo com ponto
        return isNaN(inputBanca) ? 0 : inputBanca;
    }

    function renderizarHistorico() {
        const lista = document.getElementById('lista-historico');
        lista.innerHTML = '';
        
        let countWins = 0;
        let countLosses = 0;

        historicoOperacoes.forEach(op => {
            if (op.resultado === 'WIN') {
                countWins++;
            } else {
                countLosses++;
            }
        });

        document.getElementById('count-wins').innerText = countWins;
        document.getElementById('count-losses').innerText = countLosses;
        document.getElementById('count-total').innerText = countWins + countLosses;

        // Calcula a porcentagem de WINs para a barra de progresso
        const totalOps = countWins + countLosses;
        const winPercent = totalOps > 0 ? (countWins / totalOps) * 100 : 0;
        document.getElementById('win-bar').style.width = winPercent.toFixed(1) + '%';
        
        const ultimasOperacoes = historicoOperacoes.slice(-10).reverse(); 

        ultimasOperacoes.forEach(op => {
            const li = document.createElement('li');
            const classe = op.resultado === 'WIN' ? 'historico-win' : 'historico-loss';
            const data = new Date(op.timestamp).toLocaleTimeString('pt-BR');

            li.innerHTML = `
                <span>${data} - ${op.resultado}</span>
                <span class="${classe}">P&L: R$ ${op.pnl.toFixed(2).replace('.', ',')}</span>
            `;
            lista.appendChild(li);
        });
    }

    // FUNÇÃO REQUERIDA: Confirmação Única de Reset E Limpeza de Inputs
    function tentarLimparHistorico() {
        const confirmacao = confirm("ATENÇÃO: Tem certeza que deseja limpar o histórico e resetar a banca para R$ 0,00? Esta ação não pode ser desfeita.");
        
        if (confirmacao) {
            localStorage.clear();
            
            // Resetar os Inputs de Configuração para os valores default
            document.getElementById('meta-lucro').value = ""; 
            document.getElementById('stop-loss-percent').value = ""; 
            document.getElementById('payout-percent').value = ""; 
            document.getElementById('num-entradas').value = ""; 

            // Resetar os Inputs do Bingo para os valores default
            document.getElementById('bingo-meta-total').value = "";
            document.getElementById('bingo-saldo-inicial').value = "";
            document.getElementById('bingo-num-dias').value = "";
            
            window.location.reload(); 
        }
    }

    // --- LÓGICA DO GERENCIADOR (Cálculo e Operação) ---
    function calcularEntrada() {
        const inputInicial = document.getElementById('input-banca-inicial');
        const metaLucroPercentual = parseFloat(document.getElementById('meta-lucro').value.replace(',', '.')) / 100; // CORRIGIDO: Leitura com ponto
        const stopLossPercent = parseFloat(document.getElementById('stop-loss-percent').value.replace(',', '.')) / 100; // CORRIGIDO: Leitura com ponto
        const payoutPercent = parseFloat(document.getElementById('payout-percent').value.replace(',', '.')); // CORRIGIDO: Leitura com ponto
        const numEntradas = parseInt(document.getElementById('num-entradas').value.replace(',', '.'));
        
        payoutDecimal = payoutPercent / 100;

        const novoSaldo = lerBancaInicialInput();
        
        if (!bancaInicialFixada) {
            if (novoSaldo <= 0) {
                document.getElementById('resultado-entrada').innerText = "Erro: Insira um Saldo Inicial válido.";
                return;
            }
            bancaInicial = novoSaldo;
            bancaInicialFixada = true;
            inputInicial.disabled = true; 
            inputInicial.style.backgroundColor = '#21262d'; 
            inputInicial.style.color = '#8b949e';
        }

        bancaAtual = novoSaldo; 
        const bancaBaseCalculo = bancaAtual; 

        if (bancaBaseCalculo <= 0 || metaLucroPercentual <= 0 || numEntradas < 1 || isNaN(metaLucroPercentual) || isNaN(numEntradas) || payoutPercent <= 0 || isNaN(payoutPercent) || isNaN(stopLossPercent) || stopLossPercent <= 0) {
            document.getElementById('resultado-entrada').innerText = "Erro: Preencha todos os campos (Banca, Meta, Payout, Entradas E Stop Loss) corretamente.";
            toggleResultadoBotoes(false);
            return;
        }

        // --- CÁLCULO E FIXAÇÃO DO STOP LOSS ---
        const perdaMaximaR$ = bancaBaseCalculo * (stopLossPercent); // Uso do decimal
        saldoMinimoStopLoss = bancaBaseCalculo - perdaMaximaR$;

        // --- CÁLCULO DE ENTRADA NORMAL ---
        const lucroRealDesejado = bancaBaseCalculo * metaLucroPercentual;
        const valorTotalInvestimento = lucroRealDesejado / payoutDecimal;
        valorPorEntrada = valorTotalInvestimento / numEntradas;

        document.getElementById('resultado-entrada').innerHTML = `
            Valor da entrada: <strong>R$ ${valorPorEntrada.toFixed(2).replace('.', ',')}</strong>
            <br>
            Limite de Stop Loss: <strong>R$ ${perdaMaximaR$?.toFixed(2)?.replace('.', ',')}</strong> (Banca Mínima: R$ ${saldoMinimoStopLoss.toFixed(2).replace('.', ',')})
        `;

        document.getElementById('btn-nova-operacao').disabled = false;
        document.getElementById('btn-nova-operacao').classList.remove('disabled');
        toggleResultadoBotoes(false);
        atualizarDisplay();
        salvarDados(); 
    }

    function registrarResultado(resultado) {
        if (valorPorEntrada <= 0 || !bancaInicialFixada) return;
        if (saldoMinimoStopLoss > 0 && bancaAtual <= saldoMinimoStopLoss) return; 

        let PnL = 0;
        const valorApostado = valorPorEntrada;
        
        if (resultado === 'win') {
            PnL = valorApostado * payoutDecimal; 
        } else {
            PnL = -valorApostado;
        }

        bancaAtual += PnL;

        historicoOperacoes.push({
            timestamp: new Date().getTime(),
            resultado: resultado.toUpperCase(),
            valor: valorApostado,
            pnl: PnL
        });

        // --- VERIFICAR STOP LOSS APÓS O RESULTADO ---
        if (saldoMinimoStopLoss > 0 && bancaAtual <= saldoMinimoStopLoss) {
            document.getElementById('btn-nova-operacao').disabled = true;
            document.getElementById('btn-nova-operacao').classList.add('disabled');
            
            document.getElementById('resultado-entrada').innerHTML = `
                <strong style="color: var(--cor-vermelha); font-size: 1.5em;">⛔ STOP LOSS ATINGIDO! PARE DE OPERAR. ⛔</strong>
                <br>
                O seu limite de perda foi alcançado. Saldo Atual: R$ ${bancaAtual.toFixed(2).replace('.', ',')}.
            `;
            
            toggleResultadoBotoes(false);
            valorPorEntrada = 0; 
            
        } else {
            // Simplificado o aviso de resultado e removido PNL
            document.getElementById('resultado-entrada').innerHTML = `
                ${resultado.toUpperCase()}! Novo Saldo: R$ ${bancaAtual.toFixed(2).replace('.', ',')}.
                <br>
                <strong>Clique em CALCULAR ENTRADA.</strong>
            `;
        }
        
        document.getElementById('input-banca-inicial').value = bancaAtual.toFixed(2);
        atualizarDisplay();
        salvarDados();

        if (saldoMinimoStopLoss === 0 || bancaAtual > saldoMinimoStopLoss) {
             document.getElementById('btn-nova-operacao').disabled = true;
             document.getElementById('btn-nova-operacao').classList.add('disabled');
             valorPorEntrada = 0;
        }

        toggleResultadoBotoes(false);

    }

    function toggleResultadoBotoes(show) {
        const botoesResultado = document.getElementById('botoes-resultado');
        const btnNovaOperacao = document.getElementById('btn-nova-operacao');

        if (show && valorPorEntrada > 0) {
            botoesResultado.style.display = 'block';
            btnNovaOperacao.style.display = 'none';
        } else {
            botoesResultado.style.display = 'none';
            btnNovaOperacao.style.display = 'block';
        }
    }


    // --- BINGO DO MÊS / METAS AGRESSIVAS (JURO COMPOSTO) ---
    
    function atualizarDisplayBingo() {
        const btnWin = document.getElementById('btn-bingo-win');
        const btnLoss = document.getElementById('btn-bingo-loss');

        // Arredondamento para evitar números gigantes no input
        document.getElementById('bingo-saldo-inicial').value = bingoSaldoAtual.toFixed(2).replace('.', ',');
        
        // --- 1. DISPLAY GERAL E MENSAGENS DE STATUS ---
        document.getElementById('bingo-saldo-display').innerText = `R$ ${(bingoSaldoAtual || 0).toFixed(2).replace('.', ',')}`;
        
        if (bingoFatorCrescimento > 0) {
            document.getElementById('progresso-diario').style.display = 'block';

            const fatorCrescimentoPorWIN = bingoFatorCrescimento; 
            const metaLucroPorWINR$ = (bingoSaldoAtual * fatorCrescimentoPorWIN) - bingoSaldoAtual;
            const investimentoNecessario = metaLucroPorWINR$ / BINGO_PAYOUT;
            bingoValorEntrada = investimentoNecessario;
            
            document.getElementById('bingo-wins-restantes').innerText = Math.max(0, bingoWinsRestantes);
            document.getElementById('bingo-lucro-dia').innerText = `R$ ${bingoLucroDoDia.toFixed(2).replace('.', ',')}`;
            document.getElementById('bingo-meta-diaria').innerText = `R$ ${bingoMetaDiariaLucro?.toFixed(2)?.replace('.', ',')}`; 

            // --- 2. VERIFICAÇÃO DE META ATINGIDA ---
            if (bingoSaldoAtual >= bingoMetaTotal && bingoMetaTotal > 0) {
                
                document.getElementById('resultado-bingo').innerHTML = `
                    <p style="color:var(--cor-verde); font-size: 1.2em; font-weight: bold; text-align: center;">
                        🎉 META DE R$ ${bingoMetaTotal.toFixed(2).replace('.', ',')} BATIDA!
                    </p>
                    <p style="color: #ffc107; font-size: 1.0em; text-align: center; margin-top: 10px;">
                        Mude os valores para uma nova meta.
                    </p>
                `;
                btnWin.disabled = true;
                btnWin.classList.add('disabled');
                btnLoss.disabled = true;
                btnLoss.classList.add('disabled');
                document.getElementById('bingo-valor-entrada-display').style.display = 'none';
                return; 
            }
            
            // --- 3. EXIBIÇÃO DE ALERTA DE SALDO INSUFICIENTE / ENTRADA SUGERIDA ---
            
            // Reabilita os botões se a meta ainda não foi batida
            btnWin.disabled = false;
            btnWin.classList.remove('disabled');
            btnLoss.disabled = false;
            btnLoss.classList.remove('disabled');

            // Exibição do valor de entrada em destaque
            document.getElementById('bingo-valor-entrada-display').innerText = `R$ ${bingoValorEntrada.toFixed(2).replace('.', ',')}`;
            document.getElementById('bingo-valor-entrada-display').style.display = 'block';

            if (bingoSaldoAtual <= 0) {
                 document.getElementById('resultado-bingo').innerHTML = `<span style="color:var(--cor-vermelha); font-size: 1.1em;">ATENÇÃO: Saldo zerado. Reinicie o plano com um novo saldo.</span>`;
                 btnWin.disabled = true;
                 btnWin.classList.add('disabled');
                 btnLoss.disabled = true;
                 btnLoss.classList.add('disabled');
                 document.getElementById('bingo-valor-entrada-display').style.display = 'none';
            } else if (bingoSaldoAtual < investimentoNecessario) {
                 document.getElementById('resultado-bingo').innerHTML = `<span style="color:var(--cor-vermelha); font-size: 1.1em;">SALDO INSUFICIENTE. A entrada sugerida é R$ ${investimentoNecessario.toFixed(2).replace('.', ',')}.</span>`;
            } else {
                 document.getElementById('resultado-bingo').innerHTML = ""; // Limpa mensagens se tudo estiver ok.
            }

            // Cores
            if (bingoLucroDoDia >= bingoMetaDiariaLucro && bingoMetaDiariaLucro > 0) {
                document.getElementById('bingo-lucro-dia').style.color = 'var(--cor-verde)'; // Verde
            } else {
                document.getElementById('bingo-lucro-dia').style.color = '#ffc107'; // Amarelo para lucro não atingido
            }
            
            document.getElementById('bingo-saldo-display').style.color = 'var(--cor-verde)'; 
        } else {
            document.getElementById('progresso-diario').style.display = 'none';
        }
    }


    function calcularBingo(silencioso = false) {
        const metaTotal = parseFloat(document.getElementById('bingo-meta-total').value);
        const saldoAtual = parseFloat(document.getElementById('bingo-saldo-inicial').value.replace(',', '.')); // Lendo com ponto
        const totalWinsPlanejados = parseInt(document.getElementById('bingo-num-dias').value); 
        
        // Regra de Saldo Mínimo
        const entradaMinima = 2.00;
        if (saldoAtual < entradaMinima) {
            document.getElementById('resultado-bingo').innerHTML = `<span style="color:var(--cor-vermelha); font-size: 1.1em;">SALDO INSUFICIENTE. O valor mínimo para operação é R$ ${entradaMinima.toFixed(2).replace('.', ',')}.</span>`;
            document.getElementById('progresso-diario').style.display = 'none';
            return;
        }

        if (metaTotal <= saldoAtual) {
            document.getElementById('resultado-bingo').innerHTML = `<span style="color:var(--cor-verde); font-size: 1.1em;">🎉 META JÁ ATINGIDA ou igual ao saldo! Defina uma Meta Total maior.</span>`;
            document.getElementById('progresso-diario').style.display = 'none';
            return;
        }

        if (isNaN(metaTotal) || isNaN(saldoAtual) || isNaN(totalWinsPlanejados) || totalWinsPlanejados <= 0 || metaTotal <= 0) {
            document.getElementById('resultado-bingo').innerText = "Erro: Preencha os campos corretamente.";
            document.getElementById('progresso-diario').style.display = 'none';
            return;
        }

        // --- CÁLCULO DE JUROS COMPOSTOS POR WIN (Fator de Retorno Bruto: 1 + Payout) ---
        const fatorCrescimento = Math.pow(metaTotal / saldoAtual, 1 / totalWinsPlanejados);
        
        // Salva os valores do plano
        bingoMetaTotal = metaTotal;
        bingoSaldoAtual = saldoAtual;
        bingoNumDias = totalWinsPlanejados; 
        bingoFatorCrescimento = fatorCrescimento; 
        
        // Inicializa o contador de wins restantes com o total planejado
        if (!silencioso) {
            bingoWinsRestantes = totalWinsPlanejados;
            bingoLucroDoDia = 0; // Zera o lucro do dia no novo cálculo
        }


        // A entrada deve ser calculada sobre o saldo atual:
        const metaLucroPorWINR$ = (bingoSaldoAtual * fatorCrescimento) - bingoSaldoAtual;
        const investimentoNecessario = metaLucroPorWINR$ / BINGO_PAYOUT;

        bingoMetaDiariaLucro = metaLucroPorWINR$;
        bingoValorEntrada = investimentoNecessario; 

        document.getElementById('resultado-bingo').innerHTML = `
            Crescimento Necessário por WIN: <strong>${((fatorCrescimento - 1) * 100).toFixed(2).replace('.', ',')}%</strong>
            <br>
            Meta de Lucro por WIN (Líquido): <strong>R$ ${bingoMetaDiariaLucro.toFixed(2).replace('.', ',')}</strong>
            <br>
            Total de WINs Planejados: <strong>${totalWinsPlanejados}</strong>
        `;
        
        salvarDados();
        atualizarDisplayBingo();
    }

    function registrarBingo(resultado) {
        if (bingoFatorCrescimento <= 0 || bingoSaldoAtual <= 0) {
            alert("Erro: Calcule o plano primeiro.");
            return;
        }
        
        // VALIDAÇÃO: META JÁ BATIDA
        if (bingoSaldoAtual >= bingoMetaTotal && bingoMetaTotal > 0) {
            alert(`🎉 META DE R$ ${bingoMetaTotal.toFixed(2).replace('.', ',')} JÁ FOI BATIDA! Mude os valores para uma nova meta.`);
            return;
        }

        // REGRA DE SALDO MÍNIMO PARA ENTRADA
        const entradaMinima = 2.00;
        if (bingoSaldoAtual < entradaMinima) {
            alert("Erro: Saldo insuficiente. O valor mínimo para entrada é R$ 2,00.");
            return;
        }

        // A entrada é o valor calculado, mas não menor que a mínima da corretora (2.00)
        const valorDaEntrada = Math.max(bingoValorEntrada, entradaMinima); 
        
        let PnL = 0;
        
        if (resultado === 'win') {
            PnL = valorDaEntrada * BINGO_PAYOUT; // Lucro líquido de 85%
            
            // 1. Lógica de WIN
            if (bingoWinsRestantes > 0) {
                bingoWinsRestantes--;
            }

        } else {
            PnL = -valorDaEntrada; // Perda de 100% da entrada

            // 2. Lógica de LOSS (Recálculo da Pendência)
            const novoSaldo = bingoSaldoAtual + PnL;
            
            if (novoSaldo > 0 && bingoMetaTotal > novoSaldo) {
                // N_novo = ceil( log(Meta / Saldo_Atual) / log(Fator_Crescimento) )
                const novoTotalWinsNecessarios = Math.ceil(
                    Math.log(bingoMetaTotal / novoSaldo) / Math.log(bingoFatorCrescimento)
                );
                
                // O número de WINs restantes é atualizado com o valor recalculado.
                bingoWinsRestantes = novoTotalWinsNecessarios;
            } else if (novoSaldo <= 0) {
                 bingoWinsRestantes = 0; // Se zerou ou ficou negativo
            }

        }

        bingoLucroDoDia += PnL;
        bingoSaldoAtual += PnL;

        // CORREÇÃO: Arredonda o saldo para duas casas antes de colocar no input
        document.getElementById('bingo-saldo-inicial').value = bingoSaldoAtual.toFixed(2).replace('.', ',');
        
        if (bingoSaldoAtual >= bingoMetaTotal) {
            alert(`🎉 PARABÉNS! A meta de R$ ${bingoMetaTotal.toFixed(2).replace('.', ',')} foi atingida!`);
            bingoWinsRestantes = 0;
        }
        
        salvarDados();
        atualizarDisplayBingo();
        
        if (bingoSaldoAtual <= 0) {
            alert("ATENÇÃO: Sua banca está zerada ou negativa.");
        }
    }

    // Função que zera o lucro do dia E recalcula o plano se já existia um plano
    function resetarMetaDiaria() {
        // Opção 1: ZERAR TUDO (incluindo inputs)
        if (confirm("ATENÇÃO: Deseja apagar todos os dados do plano Bingo e recomeçar do zero?")) {
            
            // Zera todas as variáveis de controle do Bingo
            bingoMetaTotal = 0;
            bingoSaldoAtual = 0;
            bingoNumDias = 0;
            bingoFatorCrescimento = 0;
            bingoLucroDoDia = 0;
            bingoValorEntrada = 0;
            bingoMetaDiariaLucro = 0;
            bingoWinsRestantes = 0;

            // Limpa os campos de input do Bingo
            document.getElementById('bingo-meta-total').value = "";
            document.getElementById('bingo-saldo-inicial').value = "";
            document.getElementById('bingo-num-dias').value = "";
            
            document.getElementById('resultado-bingo').innerHTML = ""; // Limpa o resultado
            document.getElementById('progresso-diario').style.display = 'none'; // Esconde o progresso

            salvarDados();
            atualizarDisplayBingo(); 
            alert("Meta Reiniciada! Os campos foram limpos.");
            return;
        }


        // Se o usuário clicar em CANCELAR na primeira caixa, perguntamos sobre RECALCULAR COM SALDO ATUAL
        if (confirm("Deseja Recalcular o Plano com o saldo atual?")) {
            const novoSaldoBase = parseFloat(document.getElementById('bingo-saldo-inicial').value.replace(',', '.')); // Lendo com ponto

            if (isNaN(novoSaldoBase) || novoSaldoBase <= 0) {
                alert("Erro: Saldo atual inválido para reiniciar o plano.");
                return;
            }

            // 1. Zera o lucro do dia
            bingoLucroDoDia = 0; 

            // 2. Define o novo saldo base e recalcula o plano
            bingoSaldoAtual = novoSaldoBase;
            calcularBingo(); // Recalcula o plano com o novo saldo

            alert("Meta Reiniciada e Recalculada com o Saldo Atual!");
        }
    }

    // Inicialização ao carregar a página
    window.onload = function() {
        carregarDados(); 
        atualizarDisplay();
        toggleResultadoBotoes(false);
    }
</script>

</body>
</html>
